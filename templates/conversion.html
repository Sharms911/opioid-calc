<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opioid Conversion Tool - Pharmacist Calculator</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Professional opioid morphine milligram equivalent calculator for pharmacists">
    <meta name="theme-color" content="#0d6efd">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="MME Calculator">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/static/manifest.json">
    
    <!-- iOS Icons -->
    <link rel="apple-touch-icon" sizes="152x152" href="/static/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/static/icons/icon-192x192.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/static/icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/icons/icon-16x16.png">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .conversion-result { border-left: 4px solid #28a745; background-color: #f8f9fa; }
        .warning-box { border-left: 4px solid #ffc107; background-color: #fffdf3; }
        
        /* Calculation step styling */
        .calculation-steps {
            position: relative;
        }
        .calculation-steps::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 30px;
            bottom: 30px;
            width: 2px;
            background: linear-gradient(to bottom, #0d6efd 0%, #198754 100%);
            opacity: 0.3;
        }
        .step-box {
            position: relative;
            transition: all 0.3s ease;
            border-left: 3px solid transparent !important;
        }
        .step-box:hover {
            transform: translateX(5px);
            border-left: 3px solid #0d6efd !important;
            box-shadow: 0 0.125rem 0.5rem rgba(0,0,0,0.1);
        }
        .formula-box {
            font-family: 'Courier New', monospace;
            font-size: 0.95rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        }
        .formula-box code {
            color: #0d6efd;
            font-weight: 600;
        }
        .badge {
            padding: 0.35em 0.65em;
            font-size: 0.85em;
        }
        code {
            background-color: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 500;
        }
        .card {
            transition: all 0.3s ease;
        }
        .card:hover {
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <i class="fas fa-pills"></i> Opioid MME Calculator
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('index') }}">MME Calculator</a>
                <a class="nav-link active" href="{{ url_for('conversion_tool') }}">Conversion Tool</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card">
                    <div class="card-header">
                        <h4><i class="fas fa-exchange-alt"></i> Opioid Conversion Calculator</h4>
                        <p class="mb-0 text-muted">Convert between different opioid medications</p>
                    </div>
                    <div class="card-body">
                        <form id="conversionForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>From:</h6>
                                    <div class="mb-3">
                                        <label class="form-label">Current Opioid</label>
                                        <select class="form-select" id="fromOpioid" required>
                                            <option value="">Select medication...</option>
                                            {% for opioid, data in opioids.items() %}
                                            <option value="{{ opioid }}">{{ opioid.replace('_', ' ').title() }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Current Dose (mg)</label>
                                        <input type="number" class="form-control" id="currentDose" step="0.1" min="0" required>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <h6>To:</h6>
                                    <div class="mb-3">
                                        <label class="form-label">Target Opioid</label>
                                        <select class="form-select" id="toOpioid" required>
                                            <option value="">Select medication...</option>
                                            {% for opioid, data in opioids.items() %}
                                            <option value="{{ opioid }}">{{ opioid.replace('_', ' ').title() }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-calculator"></i> Calculate Conversion
                            </button>
                        </form>
                    </div>
                </div>

                <div id="conversionResults" class="card mt-4" style="display: none;">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line"></i> Conversion Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="conversionContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Service Worker Registration for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/static/sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

        document.getElementById('conversionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            performConversion();
        });

        function performConversion() {
            const fromOpioid = document.getElementById('fromOpioid').value;
            const toOpioid = document.getElementById('toOpioid').value;
            const dose = document.getElementById('currentDose').value;

            if (!fromOpioid || !toOpioid || !dose) {
                alert('Please fill in all fields.');
                return;
            }

            if (fromOpioid === toOpioid) {
                alert('Please select different medications for conversion.');
                return;
            }

            fetch('/convert', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    from_opioid: fromOpioid,
                    to_opioid: toOpioid,
                    dose: parseFloat(dose)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayConversionResults(data);
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred during conversion.');
            });
        }

        function displayConversionResults(data) {
            const resultsDiv = document.getElementById('conversionResults');
            const contentDiv = document.getElementById('conversionContent');
            
            const fromOpioidName = document.getElementById('fromOpioid').selectedOptions[0].text;
            const toOpioidName = document.getElementById('toOpioid').selectedOptions[0].text;
            
            let html = `
                <div class="alert alert-info">
                    <h5><i class="fas fa-exchange-alt me-2"></i>Conversion Summary</h5>
                    <div class="row text-center mt-3">
                        <div class="col-md-3">
                            <h6>Original Dose</h6>
                            <div class="h4 text-primary">${data.original_dose} mg</div>
                            <small class="text-muted">${fromOpioidName}</small>
                        </div>
                        <div class="col-md-3">
                            <h6>MME Equivalent</h6>
                            <div class="h4 text-info">${data.mme_equivalent}</div>
                            <small class="text-muted">Morphine equivalent</small>
                        </div>
                        <div class="col-md-3">
                            <h6>Calculated Dose</h6>
                            <div class="h4 text-secondary">${data.converted_dose} mg</div>
                            <small class="text-muted">${toOpioidName}</small>
                        </div>
                        <div class="col-md-3">
                            <h6>Safe Starting Dose</h6>
                            <div class="h4 text-success">${data.safe_starting_dose} mg</div>
                            <small class="text-muted">Recommended</small>
                        </div>
                    </div>
                </div>
                
                <h6 class="mt-4"><i class="fas fa-calculator me-2"></i>Detailed Conversion Calculation:</h6>
                
                <div class="card mb-3 shadow-sm">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-3 text-primary">
                            <i class="fas fa-arrow-right me-2"></i>Step 1: Convert ${fromOpioidName} to MME
                        </h6>
                        <div class="calculation-steps">
                            <div class="step-box p-3 bg-light rounded mb-2">
                                <div class="row align-items-center">
                                    <div class="col-md-12">
                                        <span class="badge bg-secondary me-2">Formula</span>
                                        <strong>MME = Original Dose × Conversion Factor</strong>
                                    </div>
                                </div>
                                <div class="mt-2 ms-4">
                                    <div><i class="fas fa-circle text-primary me-2" style="font-size: 8px;"></i>Original dose: <code>${data.original_dose} mg</code></div>
                                    <div><i class="fas fa-circle text-primary me-2" style="font-size: 8px;"></i>Conversion factor for ${fromOpioidName}: <code>${data.from_factor}</code></div>
                                </div>
                            </div>
                            
                            <div class="step-box p-3 bg-light rounded mb-2">
                                <div class="row align-items-center">
                                    <div class="col-md-12">
                                        <span class="badge bg-secondary me-2">Calculate</span>
                                        <strong>Apply the formula:</strong>
                                    </div>
                                </div>
                                <div class="mt-2 ms-4">
                                    <div class="formula-box p-2 bg-white rounded border">
                                        <code>MME = ${data.original_dose} mg × ${data.from_factor} = ${data.mme_equivalent} MME</code>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="step-box p-3 bg-info bg-opacity-10 rounded">
                                <div class="row align-items-center">
                                    <div class="col-md-12">
                                        <span class="badge bg-info me-2">Result</span>
                                        <strong>MME Equivalent:</strong>
                                        <span class="fs-5 text-info ms-2"><strong>${data.mme_equivalent} MME</strong></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-3 shadow-sm">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-3 text-primary">
                            <i class="fas fa-arrow-right me-2"></i>Step 2: Convert MME to ${toOpioidName}
                        </h6>
                        <div class="calculation-steps">
                            <div class="step-box p-3 bg-light rounded mb-2">
                                <div class="row align-items-center">
                                    <div class="col-md-12">
                                        <span class="badge bg-secondary me-2">Formula</span>
                                        <strong>Target Dose = MME ÷ Target Conversion Factor</strong>
                                    </div>
                                </div>
                                <div class="mt-2 ms-4">
                                    <div><i class="fas fa-circle text-primary me-2" style="font-size: 8px;"></i>MME value: <code>${data.mme_equivalent} MME</code></div>
                                    <div><i class="fas fa-circle text-primary me-2" style="font-size: 8px;"></i>Conversion factor for ${toOpioidName}: <code>${data.to_factor}</code></div>
                                </div>
                            </div>
                            
                            <div class="step-box p-3 bg-light rounded mb-2">
                                <div class="row align-items-center">
                                    <div class="col-md-12">
                                        <span class="badge bg-secondary me-2">Calculate</span>
                                        <strong>Apply the formula:</strong>
                                    </div>
                                </div>
                                <div class="mt-2 ms-4">
                                    <div class="formula-box p-2 bg-white rounded border">
                                        <code>Target Dose = ${data.mme_equivalent} MME ÷ ${data.to_factor} = ${data.converted_dose} mg</code>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="step-box p-3 bg-secondary bg-opacity-10 rounded">
                                <div class="row align-items-center">
                                    <div class="col-md-12">
                                        <span class="badge bg-secondary me-2">Result</span>
                                        <strong>Calculated ${toOpioidName} Dose:</strong>
                                        <span class="fs-5 text-secondary ms-2"><strong>${data.converted_dose} mg</strong></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-3 shadow-sm border-success">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-3 text-success">
                            <i class="fas fa-shield-alt me-2"></i>Step 3: Apply Safety Reduction (Cross-Tolerance)
                        </h6>
                        <div class="calculation-steps">
                            <div class="step-box p-3 bg-light rounded mb-2">
                                <div class="row align-items-center">
                                    <div class="col-md-12">
                                        <span class="badge bg-warning me-2">Safety Factor</span>
                                        <strong>Apply 25% dose reduction for incomplete cross-tolerance</strong>
                                    </div>
                                </div>
                                <div class="mt-2 ms-4">
                                    <div><i class="fas fa-circle text-warning me-2" style="font-size: 8px;"></i>Calculated dose: <code>${data.converted_dose} mg</code></div>
                                    <div><i class="fas fa-circle text-warning me-2" style="font-size: 8px;"></i>Safety factor: <code>0.75 (75% of calculated dose)</code></div>
                                </div>
                            </div>
                            
                            <div class="step-box p-3 bg-light rounded mb-2">
                                <div class="row align-items-center">
                                    <div class="col-md-12">
                                        <span class="badge bg-warning me-2">Calculate</span>
                                        <strong>Apply safety reduction:</strong>
                                    </div>
                                </div>
                                <div class="mt-2 ms-4">
                                    <div class="formula-box p-2 bg-white rounded border">
                                        <code>Safe Dose = ${data.converted_dose} mg × 0.75 = ${data.safe_starting_dose} mg</code>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="step-box p-3 bg-success bg-opacity-10 rounded">
                                <div class="row align-items-center">
                                    <div class="col-md-12">
                                        <span class="badge bg-success me-2">Final Result</span>
                                        <strong>Recommended Safe Starting Dose:</strong>
                                        <span class="fs-4 text-success ms-2"><strong>${data.safe_starting_dose} mg ${toOpioidName}</strong></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="warning-box p-3 rounded">
                    <h6><i class="fas fa-exclamation-triangle text-warning"></i> Clinical Warning</h6>
                    <p class="mb-2"><strong>${data.warning}</strong></p>
                    <ul class="mb-0 small">
                        <li>Monitor patient closely during transition period</li>
                        <li>Adjust dose based on patient response and pain control</li>
                        <li>Consider breakthrough pain medication if needed</li>
                        <li>Document conversion rationale and monitoring plan</li>
                    </ul>
                </div>
            `;
            
            contentDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>