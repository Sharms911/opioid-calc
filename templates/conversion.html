<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opioid Conversion Tool - Pharmacist Calculator</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Professional opioid morphine milligram equivalent calculator for pharmacists">
    <meta name="theme-color" content="#0d6efd">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="MME Calculator">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/static/manifest.json">
    
    <!-- iOS Icons -->
    <link rel="apple-touch-icon" sizes="152x152" href="/static/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/static/icons/icon-192x192.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/static/icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/icons/icon-16x16.png">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .conversion-result { border-left: 4px solid #28a745; background-color: #f8f9fa; }
        .warning-box { border-left: 4px solid #ffc107; background-color: #fffdf3; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <i class="fas fa-pills"></i> Opioid MME Calculator
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('index') }}">MME Calculator</a>
                <a class="nav-link active" href="{{ url_for('conversion_tool') }}">Conversion Tool</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card">
                    <div class="card-header">
                        <h4><i class="fas fa-exchange-alt"></i> Opioid Conversion Calculator</h4>
                        <p class="mb-0 text-muted">Convert between different opioid medications</p>
                    </div>
                    <div class="card-body">
                        <form id="conversionForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>From:</h6>
                                    <div class="mb-3">
                                        <label class="form-label">Current Opioid</label>
                                        <select class="form-select" id="fromOpioid" required>
                                            <option value="">Select medication...</option>
                                            {% for opioid, data in opioids.items() %}
                                            <option value="{{ opioid }}">{{ opioid.replace('_', ' ').title() }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Current Dose (mg)</label>
                                        <input type="number" class="form-control" id="currentDose" step="0.1" min="0" required>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <h6>To:</h6>
                                    <div class="mb-3">
                                        <label class="form-label">Target Opioid</label>
                                        <select class="form-select" id="toOpioid" required>
                                            <option value="">Select medication...</option>
                                            {% for opioid, data in opioids.items() %}
                                            <option value="{{ opioid }}">{{ opioid.replace('_', ' ').title() }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-calculator"></i> Calculate Conversion
                            </button>
                        </form>
                    </div>
                </div>

                <div id="conversionResults" class="card mt-4" style="display: none;">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line"></i> Conversion Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="conversionContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Service Worker Registration for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/static/sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

        document.getElementById('conversionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            performConversion();
        });

        function performConversion() {
            const fromOpioid = document.getElementById('fromOpioid').value;
            const toOpioid = document.getElementById('toOpioid').value;
            const dose = document.getElementById('currentDose').value;

            if (!fromOpioid || !toOpioid || !dose) {
                alert('Please fill in all fields.');
                return;
            }

            if (fromOpioid === toOpioid) {
                alert('Please select different medications for conversion.');
                return;
            }

            fetch('/convert', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    from_opioid: fromOpioid,
                    to_opioid: toOpioid,
                    dose: parseFloat(dose)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayConversionResults(data);
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred during conversion.');
            });
        }

        function displayConversionResults(data) {
            const resultsDiv = document.getElementById('conversionResults');
            const contentDiv = document.getElementById('conversionContent');
            
            const fromOpioidName = document.getElementById('fromOpioid').selectedOptions[0].text;
            const toOpioidName = document.getElementById('toOpioid').selectedOptions[0].text;
            
            let html = `
                <div class="conversion-result p-3 rounded mb-3">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <h6>Original Dose</h6>
                            <div class="h4 text-primary">${data.original_dose} mg</div>
                            <small class="text-muted">${fromOpioidName}</small>
                        </div>
                        <div class="col-md-3">
                            <h6>MME Equivalent</h6>
                            <div class="h4 text-info">${data.mme_equivalent}</div>
                            <small class="text-muted">Morphine equivalent</small>
                        </div>
                        <div class="col-md-3">
                            <h6>Calculated Dose</h6>
                            <div class="h4 text-secondary">${data.converted_dose} mg</div>
                            <small class="text-muted">${toOpioidName}</small>
                        </div>
                        <div class="col-md-3">
                            <h6>Safe Starting Dose</h6>
                            <div class="h4 text-success">${data.safe_starting_dose} mg</div>
                            <small class="text-muted">Recommended</small>
                        </div>
                    </div>
                </div>
                
                <div class="warning-box p-3 rounded">
                    <h6><i class="fas fa-exclamation-triangle text-warning"></i> Clinical Warning</h6>
                    <p class="mb-2">${data.warning}</p>
                    <ul class="mb-0 small">
                        <li>Monitor patient closely during transition period</li>
                        <li>Adjust dose based on patient response and pain control</li>
                        <li>Consider breakthrough pain medication if needed</li>
                        <li>Document conversion rationale and monitoring plan</li>
                    </ul>
                </div>
            `;
            
            contentDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>